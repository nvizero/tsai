<%= form_for(@product_order) do |f| %>
  <% if @product_order.errors.any? %>
    <div id="error_explanation" style="display:none;">
      <% @product_order.errors.full_messages.each do |msg| %>
      <%=msg %>
            <%=@mss = "#{@mss}"+"#{msg}<br>\n" %>
      <% end %>

    </div>
  <% end %>

  <% @msg_suc = '訂購成功' %>
  <%= render 'comm/ckbox' , :mss => @mss %>
  <%= render 'comm/order_success' , :message => @msg_suc %>

<%
  #先算出長度
  len_s = order_serial_code @code_serial.count.to_s.length
  len_s = "#{len_s}#{@code_serial.count.to_i+1}"
%>


<div class="form-group">


        <div class="col-xs-6">
            <div class="col-xs-12">
                <h4 style="color:blue;">
                <%= f.label :code , '訂單編號' %>
                </h4>
                <h4 >
                  <% if !@product_order.id.nil? %>
                      <%= @product_order.code%>
                      <%=f.hidden_field :code , :id=>'code' %>
                  <% else %>
                      <%= hide_code = "#{get_random_date}#{len_s}"%>
                      <%=f.hidden_field :code ,:value => hide_code , :id=>'code'  %>
                  <% end %>
                </h4>
            </div>

            <div class="col-xs-12">
                <h4>
                <font color="red" ><%= f.label :code , '訂單日期' %></font>
                </h4>
                <h4 style="color:blue;">
                    <% if !@product_order.order_day.nil? %>
                        <input name="order_day" id="order_day" value="<%= @product_order.order_day %>" class="form-control" >
                    <% else %>
                        <input name="order_day" id="order_day" value="<%=Time.now.strftime("%Y-%m-%d")%>" class="form-control" >
                    <% end %>
                </h4>
            </div>

            <div class="col-xs-12">
                <h4><font color="red" >付款方式</font></h4>
                <h4 style="color:blue;">
                  <%= f.select(:pay_type_id , @pay_types.collect{ |pay| [pay.content , pay.id  ] } , { :selected =>@product_order.pay_type_id  } , :id=>'pay_type_id' ,:class=>'form-control'  )%>
                  <!-- <input name="pay_type_id" id="pay_type_id" value="<%=Time.now.strftime("%Y-%m-%d")%>" > -->
                </h4>
            </div>
        </div>




        <div class="col-xs-6">

            <div class="col-xs-12">
                <h4>
                  <font color="red" >
                        <% @product_order.member_id %>
                        <%= f.label :member_id, '客戶' %>
                  </font>
                </h4>
                  <%= f.select(:member_id , @members.collect{ |mem| [mem.name , mem.id  ] } , { :selected =>@product_order.member_id  },:id=>'member_id' ,:class=>'form-control'  )%>
            </div>



            <div class="col-xs-12">
                <h4 >
                  <font color="red" >預定日期</font>
                </h4>
                <h4 style="color:blue;">
                    <% if !@product_order.future_day.nil? %>
                        <input name="future_day" id="future_day" value="<%= @product_order.future_day %>" class='form-control' >
                    <% else %>
                        <input name="future_day" id="future_day" value="<%=Time.now.strftime("%Y-%m-%d")%>" class='form-control' >
                    <% end %>

                </h4>
            </div>

            <div class="col-xs-12">
                <h4 style="color:blue;"> <%= f.label :member_id, '總金額' %> </h4>
                <input type="hidden" id="all_total" value="" >

                  <h4><span id="show_all_total"><%=@product_order.total%></span></h4>
            </div>

        </div>









    <!--hr-->
    <div class="row">
        <div class="col-xs-12">
            <hr>
        </div>
    </div>
    <!--hr-->




    <span id="products_list"></span>
    <a class="btn btn-success" href="#" id="add_products" >新增產品</a>


<input type="hidden" id="old_id" value="<%=@product_order.id%>">
<table class="table table-bordered" id="products_select">

  <thead>
    </tr>
        <th>項次產品名稱</th>
        <th>訂購數量</th>
        <th>單價</th>
        <th>合計</th>
    <tr>
  </thead>
    <tbody id="tbody">





      <tr >
          <th></th>
          <th></th>
          <td>
              <input id="pedfr"  >
          </td>
          <td></td>
          <td></td>
      </tr>


  </tbody>
</table>

    <table class="table table-bordered" id="products_select">

      <thead>
        </tr>
            <th>項次</th>
            <th>產品名稱</th>
            <th>訂購數量</th>
            <th>單價</th>
            <th>合計</th>
        <tr>
      </thead>
        <tbody id="tbody">

        <%
        ci = 0;
        if !@product_order.id.nil?
              @orderInfos.each do |info|
        %>

        <input type="hidden" id="has_product_ids" value="<%=info.product_id%>">

          <tr id="tr_<%=@pro_infos[info.id]%>">
              <th>
                  <%=ci+=1 %>
                  <a class="btn btn-danger btn-sm gasd" id="<%=@pro_infos[info.id]%>" > del </a>
              </th>

              <th><%=@pro_infos[info.product_id]%></th>
              <td><input name="p_<%=info.product_id %>"  class="pids_<%=info.product_id %>" value="<%=info.num %>"     onblur="calNum(<%=info.product_id %>)"  alt="<%=info.product_id %>" ></td>
              <td><input name="price_<%=info.product_id %>" class="price_<%=info.product_id %>" value="<%=info.price %>"  onblur="calNum(<%=info.product_id %>)"  ></td>
              <td><span  class="total_<%=info.product_id %>" ><%=info.total%></span> </td>
          </tr>

        <%
              end
        end
        %>
      </tbody>
    </table>



    <%= f.hidden_field :order_state_id ,:value=>'1'%>

  </div>




  <div class="box-footer">
      <button type="button" class="btn btn-primary" id="finial">確定</button>
      <%= link_to "取消", :back ,:class =>'btn btn-danger' %>
  </div>
<% end %>

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<!--
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
-->

<script src="/admin/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

  var availableTutorials = [
               <% @products.each do |pro| %>
               "<%=pro.title%>",
               <% end %>
            ];
            $( "#pedfr" ).autocomplete({
               source: availableTutorials
            });

  //物件型式
	// $( "#pedfr" )
	//   .bind( 'focus', function(){
  //
	//   	// $(this).autocomplete("search");
  //
	//   }).bind( 'click', function(){
  //
	//   	// $(this).autocomplete("search");
  //
	//   } )
	//   .autocomplete({
	// 	minLength: 0,
	// 	source: function(request, response ) {
  //
	// 		           alert(request.term);
  //
	//                 $.ajax({
	//                     url: "/products/1.json",
	//                     dataType: "json",
	//                     data:{
	// 					                  query: request.term
	//                     },
	//                     success: function( data ) {
  //                       alert(data.title);
	//                         response( $.map( data, function( item ) {
	//                         return {
	// 							label: item.title,
	// 							value: item.id
	//                         }
	//                         }));
	//                     }
	//                 });
	//     },
	// 	focus: function() {
	// 	  return false;
	// 	},
	// 	select: function( event, ui ) {
	// 		 var terms=new Array();
	// 		 if(this.value!="")
	// 		  //  terms = this.value.split("/");
	// 		 terms.pop();
	// 		 terms.push( ui.item.value );
	// 		 terms.push( "" );
	// 		 this.value = terms.join( "/ " );
	// 		 return false;
	// 	}
	//   });


  // $('a').each(function(){
  //   // alert($(this).attr('class') );
  //     if( $(this).attr('class') == 'btn btn-danger btn-sm gasd' ){
  //
  //         $(this).click(function(){
  //             alert($(this).attr('id') );
  //         });

  //     }
  // })

  $("#future_day").datepicker({format: 'yyyy-mm-dd'});
  $("#order_day").datepicker({format: 'yyyy-mm-dd'});

  //判斷是否 存在
  var old_id = $('#old_id').val();

  if( undefined != old_id && old_id.length <1 ){
    //這是新增的時候

  $('#finial').click(function(){


      var _flag = true;

      //產品＆數量

      var  num_str    = '';
      var  price_str  = '';
      var  total_str  = '';
      var  all_str    = '';
      var  show_all_total    = 0;


      $('input[name^="p_"]').each(function(){

            num_str += $(this).attr('name') +',' + $(this).val() +'/';

            var ThisId    =  $(this).attr('alt') ;
            var ThisNum   =  $('.pids_'+ThisId  ).val() ;
            var ThisPrice =  $('.price_'+ThisId ).val() ;
            var ThisTotal =  $('.total_'+ThisId ).text() ;

            all_str += ThisId + '/' +ThisNum+ '/' +ThisPrice+ '/' +ThisTotal +',';

            show_all_total = parseInt(ThisTotal) + parseInt(show_all_total) ;


            if( $(this).val()=='' ){
                _flag=false;
            }

      });





      var mem_id  =  $("#member_id").val();

      //總金額
      $("#all_total").val( show_all_total );
      //訂單日期
      $("#future_day").val();

      // pay_type_id
      // order_day

      var date_and_totalPrice = $("#future_day").val() + '/' +
                                $("#all_total").val() + '/' +
                                $("#pay_type_id").val() + '/' +
                                $("#order_day").val()  ;
      // alert(date_and_totalPrice);



      if( mem_id == '' || mem_id==null || (_flag==false ) ){

          alert('訂購失敗!');

      }else{

          $.post( '/post_order_data',
                { 'member_id' : $("#member_id").val() ,
                  'code'      : $("#code").val() ,
                  'all_str'   : all_str,
                  'date_and_totalPrice' : date_and_totalPrice
                  },
                function(d){



                  if( true ){

                      $('#order-success-modal').modal('show');

                      $("#a_submit").click(function(){
                          //訂講成功
                          $('#order-success-modal').modal("hide");
                          var url ='/product_orders';
                          document.location.href=url;

                      });

                  }else{
                      alert('訂購失敗!');
                  }

                });

        }


  });

  }else{
    //update
    $('#finial').click(function(){
        //產品＆數量

        var _flag = true;

        //產品＆數量

        var  num_str    = '';
        var  price_str  = '';
        var  total_str  = '';
        var  all_str    = '';
        var  show_all_total    = 0;


        $('input[name^="p_"]').each(function(){

              num_str += $(this).attr('name') +',' + $(this).val() +'/';

              var ThisId    =  $(this).attr('alt') ;
              var ThisNum   =  $('.pids_'+ThisId  ).val() ;
              var ThisPrice =  $('.price_'+ThisId ).val() ;
              var ThisTotal =  $('.total_'+ThisId ).text() ;

              all_str += ThisId + '/' +ThisNum+ '/' +ThisPrice+ '/' +ThisTotal +',';

              show_all_total = parseInt(ThisTotal) + parseInt(show_all_total) ;


              if( $(this).val()=='' ){
                  _flag=false;
              }

        });





        var mem_id  =  $("#member_id").val();

        // 總金額
        $("#all_total").val( show_all_total );
        // 訂單日期
        $("#future_day").val();

        // pay_type_id
        // order_day

        var date_and_totalPrice = $("#future_day").val() + '/' +
                                  $("#all_total").val() + '/' +
                                  $("#pay_type_id").val() + '/' +
                                  $("#order_day").val()  ;
        // alert(date_and_totalPrice);



        if( mem_id == '' || mem_id==null || (_flag==false ) ){

            alert('訂購失敗!');

        }else{

          // $.post( '/update_order_data',

          // alert(
          //       'all_str\n'             +   all_str  +
          //       'date_and_totalPrice\n' +   date_and_totalPrice
          //       );

            $.post( '/update_order_data',
                  { 'member_id' : $("#member_id").val() ,
                    'code'      : $("#code").val() ,
                    'all_str'   : all_str,
                    'date_and_totalPrice':date_and_totalPrice
                    },
                  function(d){

                    if( d == 'true' ){

                        $('#order-success-modal').modal('show');

                        $("#a_submit").click(function(){
                            //訂講成功
                            $('#order-success-modal').modal("hide");
                            var url ='/product_orders';
                            document.location.href=url;

                        });

                    }else{
                        alert('訂購失敗!');
                    }

                  });

          }



        // $.post( '/update_order_data',
        //       { 'member_id' : $("#member_id").val() ,
        //         'code' : $("#code").val() ,
        //         'new':new_str,
        //         'update':update_str
        //       },
        //       function(d){
        //         //  alert(d);
        //
        //         if(d=='true'){
        //
        //           $('#order-success-modal').modal('show');
        //
        //           $("#a_submit").click(function(){
        //               $('#order-success-modal').modal("hide")
        //               var url ='/product_orders';
        //               document.location.href=url;
        //           });
        //
        //         }else{
        //
        //           alert('false love');
        //
        //         }
        //
        //       });
      });

  }




    if( undefined != old_id && old_id.length <1 ){

      //這是新增的時候
      $.post('/get_all_products',function(data){

            $('#products_list').html(data);

            var ci = 1;

            $("#add_products").click(function(){
                var product_id = $(".product_data").val() ;

                $(".product_data").find(":selected").remove();

                // /products/1.json
                $.get('/products/'+product_id+'.json',function(data){



                  var product_info =  '<tr>';
                      product_info += '<th>'+ci+'</th>';
                      product_info += '<th>'+data["title"]+'</th>';
                      product_info += '<td>'+'<input name=p_'+data["id"]+' class="pids_'+data["id"]+'"        onblur="calNum('+data["id"]+')" alt="'+data["id"]+'" ></td>';
                      product_info += '<td>'+'<input name=price_'+data["id"]+' class="price_'+data["id"]+'"   onblur="calNum('+data["id"]+')" ></td>';
                      product_info += '<td>'+'<span  class="total_'+ data["id"]+'"  id="total_'+data["id"]+'" > </span>'+'</td>';
                      product_info += '</tr>';

                  $(product_info).appendTo('#tbody');
                  ci=ci+1;



                });
            });
        });


    }else{



      var pid_str = '';

      $('input').each(function(){

        if($(this).attr('id') == "has_product_ids"){
          pid_str += $(this).val() + '/';
        }

      });


      var ci =1;
      $.post('/get_select_products',{'pids':pid_str},function(data){

          $('#products_list').html(data);

          $("#add_products").click(function(){
              var product_id = $(".product_data").val() ;

              $(".product_data").find(":selected").remove();

              // /products/1.json
              $.get('/products/'+product_id+'.json',function(data){





                var product_info =  '<tr>';
                    product_info += '<th>'+ci+'</th>';
                    product_info += '<th>'+data["title"]+'</th>';
                    product_info += '<td>'+'<input name=p_'+data["id"]+' class="pids_'+data["id"]+'"        onblur="calNum('+data["id"]+')" alt="'+data["id"]+'" ></td>';
                    product_info += '<td>'+'<input name=price_'+data["id"]+' class="price_'+data["id"]+'"   onblur="calNum('+data["id"]+')" ></td>';
                    product_info += '<td>'+'<span  class="total_'+ data["id"]+'"  id="total_'+data["id"]+'" > </span>'+'</td>';
                    product_info += '</tr>';

                $(product_info).appendTo('#tbody');
                ci=ci+1;


              });
          });
      });



    }

    var errors_msg =$('#error_explanation').html();
    // alert(errors_msg);
    if(    undefined!=errors_msg && errors_msg.length > 3){
      $('#ckbox-modal').modal('show');
    }

});


function calNum(num){

  var _num    =   "pids_"  + num ;
  var _price  =   "price_" + num ;
  var _total  =   "total_" + num ;

  // alert( _num + '/ val = ' + $('.'+_num).val()   );
  var num_flag    =   isInteger($('.'+_num).val());
  var price_flag  =   isInteger($('.'+_price).val());
  var num_val     =   $('.'+_num).val();
  var price_val   =   $('.'+_price).val();
  var show_total_price   =  0;


  if(num_flag && price_flag){
          //計算總金額
      if(  (parseInt(num_val) > 0 ) &&  ( parseInt(price_val) > 0 ) ){

          // alert(' ok can input~~!!!');
          $("."+_total).html( num_val * price_val );

          $('span[class^="total_"]').each(function(){
              show_total_price = parseInt($(this).text()) + parseInt(show_total_price);
          });


          $("#all_total").val( show_total_price );
          $("#show_all_total").html(show_total_price);

      }else{


          if(parseInt(num_val)<=0){

              $('.'+_num).val('');
              $("."+_total).html('');
              alert('必需為正整數且大於零!!');
          }

          if(parseInt(price_val)<=0){

              $('.'+_price).val('');
              $("."+_total).html('');
              alert('必需為正整數且大於零!!');
          }



      }

  }else{

      alert('數量&單價,請輸入數字!');
  }

}

function isInteger(s){
  return Math.ceil(s) == Math.floor(s);
}

function calPrice(price){
  // alert(price);
}

</script>
